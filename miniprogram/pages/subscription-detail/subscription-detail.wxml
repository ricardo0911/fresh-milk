<!--pages/subscription-detail/subscription-detail.wxml - å‘¨æœŸè´­è¯¦æƒ…é¡µé¢-->
<view class="subscription-detail-page">
    <block wx:if="{{subscription}}">
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <view class="status-card status-{{subscription.status}}">
            <view class="status-header">
                <view class="status-info">
                    <text class="status-icon">ğŸ”„</text>
                    <view class="status-text">
                        <text class="status-title">{{subscription.status_display}}</text>
                        <text class="status-desc">ä¸‹æ¬¡é…é€ï¼š{{subscription.next_delivery_date}}</text>
                    </view>
                </view>
                <view class="subscription-no">{{subscription.subscription_no}}</view>
            </view>
            
            <!-- é…é€è¿›åº¦ -->
            <view class="progress-section">
                <view class="progress-info">
                    <text class="progress-label">é…é€è¿›åº¦</text>
                    <text class="progress-value">{{subscription.delivered_count}}/{{subscription.total_periods}}æœŸ</text>
                </view>
                <view class="progress-bar-wrap">
                    <view class="progress-bar">
                        <view class="progress-fill" style="width: {{subscription.delivered_count / subscription.total_periods * 100}}%"></view>
                    </view>
                </view>
                <view class="progress-detail">
                    <text class="detail-item">å·²é…é€ {{subscription.delivered_count}} æœŸ</text>
                    <text class="detail-item">å‰©ä½™ {{subscription.remaining_count}} æœŸ</text>
                </view>
            </view>
        </view>

        <!-- å•†å“ä¿¡æ¯ -->
        <view class="product-card">
            <view class="card-header">
                <text class="card-title">è®¢é˜…å•†å“</text>
            </view>
            <view class="product-info">
                <image class="product-image" src="{{subscription.product.cover_image}}" mode="aspectFill"/>
                <view class="product-detail">
                    <text class="product-name">{{subscription.product.name}}</text>
                    <text class="product-spec">{{subscription.product.specification}} Ã— {{subscription.quantity}}</text>
                    <view class="product-price">
                        <text class="current-price">Â¥{{subscription.period_price}}/æœŸ</text>
                        <text class="original-price">Â¥{{subscription.product.price}}</text>
                    </view>
                </view>
            </view>
        </view>

        <!-- é…é€è®¡åˆ’ -->
        <view class="plan-card">
            <view class="card-header">
                <text class="card-title">é…é€è®¡åˆ’</text>
                <text class="card-action" bindtap="changeDeliveryTime">ä¿®æ”¹</text>
            </view>
            <view class="plan-info">
                <view class="plan-row">
                    <text class="plan-label">é…é€é¢‘ç‡</text>
                    <text class="plan-value">{{subscription.frequency_display}}</text>
                </view>
                <view class="plan-row">
                    <text class="plan-label">é…é€æ—¶é—´</text>
                    <text class="plan-value">{{subscription.delivery_day}} {{subscription.delivery_time}}</text>
                </view>
                <view class="plan-row">
                    <text class="plan-label">å¼€å§‹æ—¥æœŸ</text>
                    <text class="plan-value">{{subscription.start_date}}</text>
                </view>
                <view class="plan-row">
                    <text class="plan-label">é¢„è®¡ç»“æŸ</text>
                    <text class="plan-value">{{subscription.end_date}}</text>
                </view>
            </view>
        </view>

        <!-- æ”¶è´§åœ°å€ -->
        <view class="address-card" bindtap="changeAddress">
            <view class="address-icon">ğŸ“</view>
            <view class="address-info">
                <view class="address-header">
                    <text class="receiver-name">{{subscription.receiver_name}}</text>
                    <text class="receiver-phone">{{subscription.receiver_phone}}</text>
                </view>
                <text class="address-detail">{{subscription.receiver_address}}</text>
            </view>
            <view class="address-arrow">â€º</view>
        </view>

        <!-- é…é€è®°å½• -->
        <view class="records-card">
            <view class="card-header">
                <text class="card-title">é…é€è®°å½•</text>
            </view>
            <view class="records-list">
                <view 
                    wx:for="{{deliveryRecords}}" 
                    wx:key="id"
                    class="record-item status-{{item.status}}"
                >
                    <view class="record-period">
                        <text class="period-num">ç¬¬{{item.period}}æœŸ</text>
                        <text class="period-status {{item.status}}">{{item.status_display}}</text>
                    </view>
                    <view class="record-info">
                        <text class="record-date">{{item.delivery_date}}</text>
                        <text class="record-time" wx:if="{{item.delivery_time}}">{{item.delivery_time}}</text>
                    </view>
                    
                    <!-- å·²é€è¾¾çš„æ˜¾ç¤ºé…é€å‘˜ä¿¡æ¯ -->
                    <block wx:if="{{item.status === 'delivered' && item.delivery_person}}">
                        <view class="delivery-info">
                            <image class="delivery-avatar" src="{{item.delivery_person.avatar}}" mode="aspectFill"/>
                            <view class="delivery-detail">
                                <text class="delivery-name">{{item.delivery_person.name}}</text>
                                <text class="sign-info">{{item.signed_by}}</text>
                            </view>
                            <view class="delivery-actions">
                                <view 
                                    class="action-btn call"
                                    data-phone="{{item.delivery_person.phone}}"
                                    catchtap="callDelivery"
                                >ğŸ“</view>
                                <view 
                                    wx:if="{{!item.is_rated}}"
                                    class="action-btn rate"
                                    data-id="{{item.id}}"
                                    catchtap="rateDelivery"
                                >è¯„ä»·</view>
                                <view 
                                    wx:else
                                    class="rating-display"
                                >
                                    <text class="star">â˜…</text>
                                    <text class="rating-value">{{item.rating}}</text>
                                </view>
                            </view>
                        </view>
                    </block>
                </view>
            </view>
        </view>

        <!-- è´¹ç”¨æ˜ç»† -->
        <view class="fee-card">
            <view class="card-header">
                <text class="card-title">è´¹ç”¨æ˜ç»†</text>
            </view>
            <view class="fee-info">
                <view class="fee-row">
                    <text class="fee-label">å•æœŸä»·æ ¼</text>
                    <text class="fee-value">Â¥{{subscription.period_price}} Ã— {{subscription.total_periods}}æœŸ</text>
                </view>
                <view class="fee-row">
                    <text class="fee-label">è®¢é˜…æ€»é¢</text>
                    <text class="fee-value">Â¥{{subscription.total_price}}</text>
                </view>
                <view class="fee-row">
                    <text class="fee-label">å·²ä»˜é‡‘é¢</text>
                    <text class="fee-value highlight">Â¥{{subscription.paid_amount}}</text>
                </view>
            </view>
        </view>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <view class="action-bar">
            <button class="action-btn secondary" bindtap="cancelSubscription">å–æ¶ˆè®¢é˜…</button>
            <button class="action-btn secondary" bindtap="pauseSubscription">æš‚åœé…é€</button>
        </view>
    </block>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-state" wx:else>
        <text>åŠ è½½ä¸­...</text>
    </view>
</view>
