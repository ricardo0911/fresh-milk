<!--pages/order-detail/order-detail.wxml - è®¢å•è¯¦æƒ…é¡µé¢-->
<view class="order-detail-page">
    <block wx:if="{{order}}">
        <!-- è®¢å•çŠ¶æ€å¡ç‰‡ -->
        <view class="status-card status-{{order.status}}">
            <view class="status-info">
                <text class="status-icon">
                    {{order.status === 'pending' ? 'ğŸ’°' : 
                      order.status === 'paid' ? 'ğŸ“¦' : 
                      order.status === 'shipped' ? 'ğŸšš' : 
                      order.status === 'delivered' ? 'ğŸ“¬' : 
                      order.status === 'completed' ? 'âœ…' : 'ğŸ“‹'}}
                </text>
                <view class="status-text">
                    <text class="status-title">{{order.status_display}}</text>
                    <text class="status-desc" wx:if="{{order.status === 'shipped'}}">
                        é¢„è®¡ {{order.expected_delivery}} é€è¾¾
                    </text>
                </view>
            </view>
            <!-- å‘¨æœŸè´­æ ‡è¯† -->
            <view class="subscription-badge" wx:if="{{order.is_subscription}}">
                <text class="badge-icon">ğŸ”„</text>
                <text class="badge-text">ç¬¬{{order.current_period}}/{{order.subscription_periods}}æœŸ</text>
            </view>
        </view>

        <!-- é…é€è¿›åº¦ -->
        <view class="progress-card">
            <view class="card-header">
                <text class="card-title">é…é€è¿›åº¦</text>
            </view>
            <view class="progress-timeline">
                <view
                    wx:for="{{progressSteps}}"
                    wx:key="title"
                    class="timeline-item {{item.completed ? 'completed' : ''}} {{item.current ? 'current' : ''}} {{item.pending ? 'pending' : ''}}"
                >
                    <view class="timeline-icon">{{item.icon}}</view>
                    <view class="timeline-line" wx:if="{{index < progressSteps.length - 1}}"></view>
                    <view class="timeline-content">
                        <text class="timeline-title">{{item.title}}</text>
                        <text class="timeline-time">{{item.time}}</text>
                    </view>
                </view>
            </view>
        </view>

        <!-- ç‰©æµä¿¡æ¯ -->
        <view class="express-card" wx:if="{{order.express_no}}" bindtap="viewExpressTrace">
            <view class="card-header">
                <text class="card-title">ç‰©æµä¿¡æ¯</text>
                <text class="card-arrow">â€º</text>
            </view>
            <view class="express-info">
                <view class="express-company">
                    <text class="express-icon">ğŸšš</text>
                    <text class="express-name">{{expressCompanyName}}</text>
                    <text class="express-no">{{order.express_no}}</text>
                    <text class="copy-btn" catchtap="copyExpressNo">å¤åˆ¶</text>
                </view>
                <view class="express-latest" wx:if="{{latestTrace}}">
                    <text class="trace-time">{{latestTrace.time}}</text>
                    <text class="trace-desc">{{latestTrace.description}}</text>
                </view>
                <view class="express-latest" wx:else>
                    <text class="trace-desc">æš‚æ— ç‰©æµä¿¡æ¯ï¼Œè¯·ç¨åæŸ¥çœ‹</text>
                </view>
            </view>
        </view>

        <!-- é…é€å‘˜ä¿¡æ¯ -->
        <view class="delivery-card" wx:if="{{deliveryPerson && (order.status === 'shipped' || order.status === 'delivered')}}">
            <view class="card-header">
                <text class="card-title">é…é€å‘˜</text>
            </view>
            <view class="delivery-info">
                <image class="delivery-avatar" src="{{deliveryPerson.avatar}}" mode="aspectFill"/>
                <view class="delivery-detail">
                    <text class="delivery-name">{{deliveryPerson.name}}</text>
                    <view class="delivery-stats">
                        <text class="stat-item">â­ {{deliveryPerson.rating}}</text>
                        <text class="stat-item">ğŸ“¦ {{deliveryPerson.total_deliveries}}å•</text>
                    </view>
                </view>
                <view class="call-btn" bindtap="callDelivery">
                    <text class="call-icon">ğŸ“</text>
                    <text class="call-text">è”ç³»</text>
                </view>
            </view>
        </view>

        <!-- æ”¶è´§åœ°å€ -->
        <view class="address-card">
            <view class="address-icon">ğŸ“</view>
            <view class="address-info">
                <view class="address-header">
                    <text class="receiver-name">{{order.receiver_name}}</text>
                    <text class="receiver-phone">{{order.receiver_phone}}</text>
                </view>
                <text class="address-detail">{{order.receiver_address}}</text>
            </view>
        </view>

        <!-- å•†å“åˆ—è¡¨ -->
        <view class="products-card">
            <view class="card-header">
                <text class="card-title">å•†å“ä¿¡æ¯</text>
            </view>
            <view class="product-list">
                <view class="product-item" wx:for="{{order.items}}" wx:key="id">
                    <image class="product-image" src="{{item.cover_image}}" mode="aspectFill"/>
                    <view class="product-info">
                        <text class="product-name">{{item.name}}</text>
                        <text class="product-spec">{{item.specification}}</text>
                        <view class="product-price-row">
                            <text class="product-price">Â¥{{item.price}}</text>
                            <text class="product-qty">Ã—{{item.quantity}}</text>
                        </view>
                    </view>
                    <text class="product-total">Â¥{{item.total_price}}</text>
                </view>
            </view>
            <!-- ä»·æ ¼æ˜ç»† -->
            <view class="price-detail">
                <view class="price-row">
                    <text class="price-label">å•†å“æ€»é¢</text>
                    <text class="price-value">Â¥{{order.total_amount}}</text>
                </view>
                <view class="price-row">
                    <text class="price-label">é…é€è´¹</text>
                    <text class="price-value">Â¥{{order.delivery_fee}}</text>
                </view>
                <view class="price-row" wx:if="{{order.discount_amount > 0}}">
                    <text class="price-label">ä¼˜æƒ </text>
                    <text class="price-value discount">-Â¥{{order.discount_amount}}</text>
                </view>
                <view class="price-row total">
                    <text class="price-label">å®ä»˜æ¬¾</text>
                    <text class="price-value">Â¥{{order.pay_amount}}</text>
                </view>
            </view>
        </view>

        <!-- å‘¨æœŸè´­ä¿¡æ¯ -->
        <view class="subscription-card" wx:if="{{order.is_subscription}}" bindtap="viewSubscription">
            <view class="card-header">
                <text class="card-title">å‘¨æœŸè´­ä¿¡æ¯</text>
                <text class="card-arrow">â€º</text>
            </view>
            <view class="subscription-info">
                <view class="sub-row">
                    <text class="sub-label">è®¢é˜…ç¼–å·</text>
                    <text class="sub-value">{{order.subscription_no}}</text>
                </view>
                <view class="sub-row">
                    <text class="sub-label">é…é€é¢‘ç‡</text>
                    <text class="sub-value">{{order.subscription_frequency}}</text>
                </view>
                <view class="sub-row">
                    <text class="sub-label">é…é€è¿›åº¦</text>
                    <view class="sub-progress">
                        <view class="progress-bar">
                            <view class="progress-fill" style="width: {{order.current_period / order.subscription_periods * 100}}%"></view>
                        </view>
                        <text class="progress-text">{{order.current_period}}/{{order.subscription_periods}}æœŸ</text>
                    </view>
                </view>
            </view>
        </view>

        <!-- è®¢å•ä¿¡æ¯ -->
        <view class="order-info-card">
            <view class="card-header">
                <text class="card-title">è®¢å•ä¿¡æ¯</text>
            </view>
            <view class="info-list">
                <view class="info-row">
                    <text class="info-label">è®¢å•ç¼–å·</text>
                    <view class="info-value-wrap">
                        <text class="info-value">{{order.order_no}}</text>
                        <text class="copy-btn" bindtap="copyOrderNo">å¤åˆ¶</text>
                    </view>
                </view>
                <view class="info-row">
                    <text class="info-label">ä¸‹å•æ—¶é—´</text>
                    <text class="info-value">{{order.created_at}}</text>
                </view>
                <view class="info-row" wx:if="{{order.paid_at}}">
                    <text class="info-label">æ”¯ä»˜æ—¶é—´</text>
                    <text class="info-value">{{order.paid_at}}</text>
                </view>
                <view class="info-row" wx:if="{{order.remark}}">
                    <text class="info-label">è®¢å•å¤‡æ³¨</text>
                    <text class="info-value">{{order.remark}}</text>
                </view>
            </view>
        </view>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <view class="action-bar">
            <!-- å¾…ä»˜æ¬¾ -->
            <block wx:if="{{order.status === 'pending'}}">
                <button class="action-btn secondary" bindtap="cancelOrder">å–æ¶ˆè®¢å•</button>
                <button class="action-btn primary" bindtap="payOrder">ç«‹å³æ”¯ä»˜</button>
            </block>
            
            <!-- å¾…å‘è´§ -->
            <block wx:elif="{{order.status === 'paid'}}">
                <button class="action-btn secondary" bindtap="applyAfterSale">ç”³è¯·é€€æ¬¾</button>
            </block>
            
            <!-- é…é€ä¸­ -->
            <block wx:elif="{{order.status === 'shipped'}}">
                <button class="action-btn secondary" bindtap="applyAfterSale">ç”³è¯·å”®å</button>
                <button class="action-btn primary" bindtap="confirmReceive">ç¡®è®¤æ”¶è´§</button>
            </block>
            
            <!-- å·²é€è¾¾/å·²å®Œæˆ -->
            <block wx:elif="{{order.status === 'delivered' || order.status === 'completed'}}">
                <button class="action-btn secondary" bindtap="buyAgain">å†æ¬¡è´­ä¹°</button>
                <button class="action-btn secondary" bindtap="applyAfterSale">ç”³è¯·å”®å</button>
                <button class="action-btn primary" wx:if="{{!order.is_reviewed}}" bindtap="goToReview">å»è¯„ä»·</button>
            </block>
        </view>
    </block>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-state" wx:else>
        <text>åŠ è½½ä¸­...</text>
    </view>
</view>
