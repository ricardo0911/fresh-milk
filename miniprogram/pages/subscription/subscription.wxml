<!-- pages/subscription/subscription.wxml - å‘¨æœŸè´­ -->
<view class="page-subscription">
  <!-- é¡¶éƒ¨æ ‡ç­¾ -->
  <view class="tabs">
    <view class="tab {{currentTab === 'products' ? 'active' : ''}}" bindtap="switchTab" data-tab="products">
      å‘¨æœŸè´­äº§å“
    </view>
    <view class="tab {{currentTab === 'my' ? 'active' : ''}}" bindtap="switchTab" data-tab="my">
      æˆ‘çš„è®¢é˜…
    </view>
  </view>

  <!-- å‘¨æœŸè´­äº§å“åˆ—è¡¨ -->
  <view class="product-list" wx:if="{{currentTab === 'products'}}">
    <view class="product-card" wx:for="{{products}}" wx:key="id" bindtap="selectProduct" data-product="{{item}}">
      <image class="product-image" src="{{item.cover_image}}" mode="aspectFill" />
      <view class="product-info">
        <view class="product-header">
          <text class="product-name">{{item.name}}</text>
          <text class="subscription-badge">å‘¨æœŸè´­</text>
        </view>
        <text class="product-spec">{{item.specification}}</text>
        <view class="product-prices">
          <text class="price">{{item.subscription_price || item.price}}</text>
          <text class="original-price" wx:if="{{item.original_price}}">Â¥{{item.original_price}}</text>
        </view>
        <text class="discount-hint">å‘¨æœŸè´­äº«9æŠ˜ä¼˜æƒ </text>
      </view>
    </view>

    <view class="empty-state" wx:if="{{products.length === 0}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— å‘¨æœŸè´­äº§å“</text>
    </view>
  </view>

  <!-- æˆ‘çš„è®¢é˜… -->
  <view class="subscription-list" wx:if="{{currentTab === 'my'}}">
    <view class="subscription-card" wx:for="{{subscriptions}}" wx:key="id">
      <view class="subscription-header">
        <text class="subscription-status status-{{item.status}}">{{item.status_display}}</text>
        <text class="subscription-no">è®¢é˜…å·: {{item.subscription_no}}</text>
      </view>
      <view class="subscription-body">
        <image class="subscription-image" src="{{item.product.cover_image}}" mode="aspectFill" />
        <view class="subscription-info">
          <text class="subscription-name">{{item.product.name}}</text>
          <view class="subscription-detail">
            <text>é…é€å‘¨æœŸ: {{item.frequency_display}}</text>
            <text>å…±{{item.total_periods}}æœŸ</text>
          </view>
          <view class="subscription-detail">
            <text>å·²é…é€: {{item.delivered_count}}æœŸ</text>
            <text>ä¸‹æ¬¡é…é€: {{item.next_delivery_date}}</text>
          </view>
        </view>
      </view>
      <view class="subscription-footer">
        <text class="subscription-price">Â¥{{item.period_price}}/æœŸ</text>
        <button class="btn-cancel" wx:if="{{item.status === 'active'}}" catchtap="cancelSubscription" data-id="{{item.id}}">
          æš‚åœè®¢é˜…
        </button>
      </view>
    </view>

    <view class="empty-state" wx:if="{{subscriptions.length === 0}}">
      <text class="empty-icon">ğŸ“…</text>
      <text class="empty-text">æš‚æ— è®¢é˜…</text>
      <button class="btn btn-primary" bindtap="switchToProducts">å»è®¢é˜…</button>
    </view>
  </view>

  <!-- è®¢é˜…é…ç½®å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showModal}}" bindtap="closeModal"></view>
  <view class="modal-content" wx:if="{{showModal}}">
    <view class="modal-header">
      <text class="modal-title">é…ç½®å‘¨æœŸè´­</text>
      <text class="modal-close" bindtap="closeModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <!-- äº§å“ä¿¡æ¯ -->
      <view class="selected-product">
        <image class="selected-image" src="{{selectedProduct.cover_image}}" mode="aspectFill" />
        <view class="selected-info">
          <text class="selected-name">{{selectedProduct.name}}</text>
          <text class="selected-spec">{{selectedProduct.specification}}</text>
        </view>
      </view>

      <!-- é…é€é¢‘ç‡ -->
      <view class="config-section">
        <text class="config-label">é…é€é¢‘ç‡</text>
        <view class="config-options">
          <view class="config-option {{frequency === 'daily' ? 'active' : ''}}" bindtap="setFrequency" data-value="daily">
            æ¯æ—¥
          </view>
          <view class="config-option {{frequency === 'weekly' ? 'active' : ''}}" bindtap="setFrequency" data-value="weekly">
            æ¯å‘¨ä¸€æ¬¡
          </view>
          <view class="config-option {{frequency === 'biweekly' ? 'active' : ''}}" bindtap="setFrequency" data-value="biweekly">
            æ¯ä¸¤å‘¨
          </view>
        </view>
      </view>

      <!-- é…é€æœŸæ•° -->
      <view class="config-section">
        <text class="config-label">é…é€æœŸæ•°</text>
        <view class="config-options">
          <view class="config-option {{periods === 4 ? 'active' : ''}}" bindtap="setPeriods" data-value="4">
            4æœŸ
          </view>
          <view class="config-option {{periods === 8 ? 'active' : ''}}" bindtap="setPeriods" data-value="8">
            8æœŸ
          </view>
          <view class="config-option {{periods === 12 ? 'active' : ''}}" bindtap="setPeriods" data-value="12">
            12æœŸèµ·è®¢
          </view>
        </view>
      </view>

      <!-- æ¯æœŸæ•°é‡ -->
      <view class="config-section">
        <text class="config-label">æ¯æœŸæ•°é‡</text>
        <view class="quantity-selector">
          <text class="qty-btn" bindtap="decreaseQty">âˆ’</text>
          <text class="qty-value">{{quantity}}</text>
          <text class="qty-btn" bindtap="increaseQty">+</text>
        </view>
      </view>

      <!-- å¼€å§‹æ—¥æœŸ -->
      <view class="config-section">
        <text class="config-label">æœ€æ—©é…é€</text>
        <picker mode="date" value="{{startDate}}" start="{{minDate}}" bindchange="setStartDate">
          <view class="date-picker">
            <text>{{startDate}}</text>
            <text class="picker-arrow">></text>
          </view>
        </picker>
      </view>

      <!-- ä»·æ ¼æ±‡æ€» -->
      <view class="price-summary">
        <view class="summary-row">
          <text>å•æœŸä»·æ ¼</text>
          <text class="price">{{periodPrice}}</text>
        </view>
        <view class="summary-row total">
          <text>æ€»è®¡ ({{periods}}æœŸ)</text>
          <text class="price total-price">{{totalPrice}}</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn btn-primary btn-block" bindtap="confirmSubscription">ç¡®è®¤è®¢é˜…</button>
    </view>
  </view>
</view>
